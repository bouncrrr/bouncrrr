<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>account management - bouncrrr</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="bouncrrr-favicon.ico" type="image/x-icon">
    <style>
        /* Add styles to hide the form initially */
        #password-change-form {
            display: none;
        }
    </style>
</head>
<body class="info-page">
    <div id="background-animation"></div>
    <div class="navbar navbar-visible" id="navbar">
        <a href="index.html">home</a>
    </div>
    <header>
        <h2>account management</h2>
    </header>
    <main>
        <section id="reset-password-section" class="account-section">
            <h4>reset your password</h4>
            <button id="reset-password" class="account-button">reset password</button>
            <form id="password-change-form">
                <input type="password" id="new-password" placeholder="new password" required>
                <input type="password" id="confirm-new-password" placeholder="confirm new password" required>
                <button type="submit">update password</button>
            </form>
        </section>
        <section id="subscription-details" class="account-section">
            <h4>subscription details</h4>
            <p>status: <span id="subscription-status">loading...</span></p>
            <button id="manage-subscription" class="account-button">manage subscription</button>
            <p id="subscription-message"></p>
        </section>
        <section id="registered-machines" class="account-section">
            <h4>registered devices</h4>
            <div id="machines-list"></div>
        </section>
        <section id="email-preferences" class="account-section">
            <h4>email preferences</h4>
            <label for="marketing-emails" class="account-label">opt in for marketing emails:</label>
            <input type="checkbox" id="marketing-emails">
            <button id="update-email-preferences" class="account-button">update preferences</button>
            <p id="email-preference-message"></p>
        </section>
        <center><button id="logout-button" class="account-button">log out</button></center>
    </main>
    <footer>
        <a href="privacy.html">privacy notice</a> | 
        <a href="support.html">support</a> | 
        <a href="terms.html">terms of use/refund policy</a>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            const token = localStorage.getItem('userToken');
            if (!token) {
                // Redirect to login page with a redirect URL
                const redirectUrl = encodeURIComponent(window.location.href);
                window.location.href = `login.html?redirect=${redirectUrl}`;
            } else {
                // Initialize data loading and event listeners
                loadMarketingOptInStatus();
                loadSubscriptionStatus();
                loadRegisteredMachines();

                document.getElementById('update-email-preferences').addEventListener('click', updateMarketingOptInStatus);
                document.getElementById('logout-button').addEventListener('click', handleLogout);
                document.getElementById('manage-subscription').addEventListener('click', manageSubscription);
                document.getElementById('reset-password').addEventListener('click', function() {
                    document.getElementById('password-change-form').style.display = 'block';
                });
                document.getElementById('password-change-form').addEventListener('submit', handleChangePassword);
            }
        });

        async function handleChangePassword(e) {
            e.preventDefault();
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-new-password').value;
            if (newPassword !== confirmPassword) {
                alert('passwords do not match.');
                return;
            }

            const token = localStorage.getItem('userToken');
            if (!token) {
                alert('user not authenticated.');
                return;
            }

            try {
                const response = await fetch('https://paddle-cockroach-bouncrrr.onrender.com/api/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ password: newPassword })
                });

                if (response.ok) {
                    alert('your password has been updated successfully.');
                    window.location.href = 'login.html'; // Optional: Redirect to login on success
                } else {
                    const errorMessage = await response.text();
                    alert('failed to update password. please try again or contact support.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('an error occurred. please try again later.');
            }
        }

        // Other functions for loading data, handling logout, etc. (unchanged)
    </script>
</body>
</html>
