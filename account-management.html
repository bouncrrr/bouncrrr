<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Management - bouncrrr</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="bouncrrr-favicon.ico" type="image/x-icon">
</head>
<body class="info-page">
    <div id="background-animation"></div>
    <div class="navbar navbar-visible" id="navbar">
        <a href="index.html">home</a>
    </div>
    <header>
        <h2>account management</h2>
    </header>
    <main>
        <section id="subscription-details" class="account-section">
            <h4>subscription details</h4>
            <p>Status: <span id="subscription-status">loading...</span></p>
            <button id="manage-subscription" class="account-button">manage subscription</button>
            <p id="subscription-message"></p>
        </section>
        <section id="email-preferences" class="account-section">
            <h4>email preferences</h4>
            <label for="marketing-emails" class="account-label">opt in for marketing emails:</label>
            <input type="checkbox" id="marketing-emails">
            <button id="update-email-preferences" class="account-button">update preferences</button>
            <p id="email-preference-message"></p>
        </section>
<center><button id="logout-button" class="account-button">log out</button></center>
    </main>
    <footer>
        <a href="privacy.html">privacy notice</a> | 
        <a href="support.html">support</a> | 
        <a href="terms.html">terms of use/refund policy</a>
    </footer>

<script>
// Function to load the current marketing opt-in status
async function loadMarketingOptInStatus() {
    const paddleCustomerId = localStorage.getItem('paddleCustomerId'); // Retrieve the customer ID
    console.log('Loaded Customer ID:', paddleCustomerId); // Log the customer ID for verification

    if (!paddleCustomerId) {
        console.error('Customer ID is missing.');
        return; // Optionally handle this case more gracefully
    }

    const url = `https://paddle-cockroach-bouncrrr.onrender.com/get-marketing-preferences?customerId=${paddleCustomerId}`;
    const response = await fetch(url);
    if (!response.ok) {
        throw new Error('Failed to fetch marketing opt-in status');
    }
    const data = await response.json();
    document.getElementById('marketing-emails').checked = data.marketingOptIn;
}

// Function to update the marketing opt-in status
async function updateMarketingOptInStatus(e) {
    e.preventDefault(); // Prevent the form from submitting

    const paddleCustomerId = localStorage.getItem('paddleCustomerId'); // Retrieve the customer ID again
    console.log('Updating for Customer ID:', paddleCustomerId); // Log the customer ID for verification

    if (!paddleCustomerId) {
        console.error('Customer ID is missing.');
        return; // Optionally handle this case more gracefully
    }

    const marketingOptIn = document.getElementById('marketing-emails').checked;
    const url = `https://paddle-cockroach-bouncrrr.onrender.com/update-marketing-preferences`;

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ paddleCustomerId, marketingOptIn }),
        });

        if (!response.ok) {
            throw new Error('Network response was not ok');
        }

        const responseMessage = await response.text();
        document.getElementById('email-preference-message').textContent = responseMessage;
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('email-preference-message').textContent = 'Failed to update preferences. Please try again later.';
    }
}

async function loadSubscriptionStatus() {
    // No need for customer ID here since the backend uses the token to identify the user
    const url = 'https://paddle-cockroach-bouncrrr.onrender.com/api/get-subscription-status';
    try {
        // Assuming the user's token is stored in localStorage or sessionStorage
        const token = localStorage.getItem('userToken');
        if (!token) {
            console.error('User token is missing.');
            return; // Handle missing token scenario
        }

        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`, // Use the token for authentication
            },
        });

        if (!response.ok) {
            throw new Error('Failed to fetch subscription status');
        }

        const { status } = await response.json();
        document.getElementById('subscription-status').textContent = status;
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('subscription-status').textContent = 'Failed to load status';
    }
}

    document.getElementById('logout-button').addEventListener('click', function(e) {
        e.preventDefault(); // Prevent default link action
        localStorage.removeItem('userEmail'); // Clear user email from storage
        window.location.href = 'index.html'; // Redirect to homepage or login page

    // Redirect to the homepage
    window.location.href = 'index.html';
}

// Attach event listeners after the DOM content has fully loaded to ensure elements are available
document.addEventListener('DOMContentLoaded', function () {
    document.getElementById('update-email-preferences').addEventListener('click', updateMarketingOptInStatus);
    loadMarketingOptInStatus(); // It's safer to call this here to ensure the DOM is fully loaded
    loadSubscriptionStatus(); // Add this call to load the subscription status
    document.getElementById('logout-button').addEventListener('click', handleLogout);
});
</script>

</body>
</html>
