<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>account management - bouncrrr</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="bouncrrr-favicon.ico" type="image/x-icon">
</head>
<body class="info-page">
    <div id="background-animation"></div>
    <div class="navbar navbar-visible" id="navbar">
        <a href="index.html">home</a>
    </div>
    <header>
        <h2>account management</h2>
    </header>
    <main>
        <section id="change-password-section" class="account-section">
    <h4>change your password</h4>
    <button id="change-password" class="account-button">change password</button>
</section>
        <section id="subscription-details" class="account-section">
            <h4>subscription details</h4>
            <p>status: <span id="subscription-status">loading...</span></p>
            <button id="manage-subscription" class="account-button">manage subscription</button>
            <p id="subscription-message"></p>
        </section>
        <section id="registered-machines" class="account-section">
            <h4>registered devices</h4>
            <div id="machines-list"></div>
        </section>
        <section id="email-preferences" class="account-section">
            <h4>email preferences</h4>
            <label for="marketing-emails" class="account-label">opt in for marketing emails:</label>
            <input type="checkbox" id="marketing-emails">
            <button id="update-email-preferences" class="account-button">update preferences</button>
            <p id="email-preference-message"></p>
        </section>
        <center><button id="logout-button" class="account-button">log out</button></center>
    </main>
    <footer>
        <a href="privacy.html">privacy notice</a> | 
        <a href="support.html">support</a> | 
        <a href="terms.html">terms of use/refund policy</a>
    </footer>

    <script>
document.addEventListener('DOMContentLoaded', async function () {
    const token = localStorage.getItem('userToken');
    if (!token) {
        // Redirect to login page with a redirect URL
        const redirectUrl = encodeURIComponent(window.location.href);
        window.location.href = `login.html?redirect=${redirectUrl}`;
    } else {
        // Initialize data loading and event listeners
        loadMarketingOptInStatus();
        loadSubscriptionStatus();
        loadRegisteredMachines();

        document.getElementById('update-email-preferences').addEventListener('click', updateMarketingOptInStatus);
        document.getElementById('logout-button').addEventListener('click', handleLogout);
        document.getElementById('manage-subscription').addEventListener('click', manageSubscription);
    }
});

async function loadMarketingOptInStatus() {
    const token = localStorage.getItem('userToken');
    if (!token) {
        console.error('user token is missing.');
        return;
    }

    const url = 'https://paddle-cockroach-bouncrrr.onrender.com/api/get-marketing-preferences';
    const response = await fetch(url, {
        method: 'GET',
        headers: { 'Authorization': `Bearer ${token}` }
    });

    if (!response.ok) {
        const errMsg = await response.text();
        throw new Error(`failed to fetch marketing opt-in status: ${errMsg}`);
    }
    const data = await response.json();
    document.getElementById('marketing-emails').checked = data.marketingOptIn;
}

async function updateMarketingOptInStatus(e) {
    e.preventDefault();
    const marketingOptIn = document.getElementById('marketing-emails').checked;
    const token = localStorage.getItem('userToken');
    if (!token) {
        console.error('user token is missing.');
        return;
    }

    const url = 'https://paddle-cockroach-bouncrrr.onrender.com/api/update-marketing-preferences';
    const response = await fetch(url, {
        method: 'POST',
        headers: { 
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json' 
        },
        body: JSON.stringify({ marketingOptIn })
    });

    if (!response.ok) {
        const errMsg = await response.text();
        throw new Error(`network response was not ok: ${errMsg}`);
    }

    const responseMessage = await response.text();
    document.getElementById('email-preference-message').textContent = responseMessage;
}

async function loadSubscriptionStatus() {
    const url = 'https://paddle-cockroach-bouncrrr.onrender.com/api/get-subscription-status';
    const token = localStorage.getItem('userToken');
    if (!token) {
        console.error('User token is missing.');
        return;
    }

    const response = await fetch(url, {
        method: 'GET',
        headers: { 'Authorization': `Bearer ${token}` }
    });

    if (!response.ok) {
        console.error('Failed to fetch subscription status');
        document.getElementById('subscription-status').textContent = 'Failed to load';
        return;
    }

    const data = await response.json();
    // Check explicitly for null or 'null' string
    let status = data.status;
    if (status === null || status === 'null' || status === 'NULL') {
        status = 'no subscription';
    }

    document.getElementById('subscription-status').textContent = status || 'no subscription'; // Further fallback if status is still falsy
    updateManageSubscriptionButton(status, data.trialStarted);
}

function updateManageSubscriptionButton(status, trialStarted) {
    const manageButton = document.getElementById('manage-subscription');
    switch (status) {
        case 'active':
        case 'trialing':
            manageButton.textContent = 'cancel subscription at next billing date';
            break;
        case 'canceled':
            manageButton.textContent = trialStarted ? 're-subscribe' : 'start subscription';
            break;
        case 'no subscription': // Handle no subscription case
            manageButton.textContent = 'subscribe';
            break;
        default:
            manageButton.textContent = 'manage subscription';
            break;
    }
}

function handleLogout() {
    console.log('Initiating logout process...');

    // Remove user-related information from local storage
    localStorage.removeItem('userEmail');
    localStorage.removeItem('userToken');
    localStorage.removeItem('paddleCustomerId');

    console.log('user credentials removed from local storage.');
    window.location.href = 'index.html';
}

function manageSubscription() {
    const status = document.getElementById('subscription-status').textContent;
    if (status === 'active') {
        if (confirm('are you sure you want to cancel your subscription? this will take effect at your next billing date.')) {
            // Call to server to cancel subscription
            cancelSubscription();
        }
    } else {
        window.location.href = 'https://bouncrrr.co/index.html#pricing';
    }
}

async function cancelSubscription() {
    const response = await fetch('https://paddle-cockroach-bouncrrr.onrender.com/api/cancel-subscription', {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${localStorage.getItem('userToken')}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ effectiveFrom: 'next_billing_period' }) // Only send necessary data
    });

    if (response.ok) {
        alert('your subscription will be canceled at the next billing date.');
        document.getElementById('subscription-status').textContent = 'pending cancellation';
        updateManageSubscriptionButton('pending cancellation');
    } else {
        const error = await response.json();
        console.error('Failed to cancel subscription:', error);
        alert('failed to cancel subscription. please try again or contact support.');
    }
}

async function loadRegisteredMachines() {
    const token = localStorage.getItem('userToken');
    if (!token) {
        console.error('user token is missing.');
        return;
    }

    const url = 'https://paddle-cockroach-bouncrrr.onrender.com/api/get-registered-machines';
    const response = await fetch(url, {
        method: 'GET',
        headers: { 'Authorization': `Bearer ${token}` }
    });

    if (!response.ok) {
        throw new Error('failed to fetch registered machines');
    }

    const machines = await response.json();
    const machinesContainer = document.getElementById('machines-list');
    machinesContainer.innerHTML = ''; // Clear previous entries
    machines.forEach(machine => {
        const machineElement = document.createElement('div');
        machineElement.innerHTML = `
            <p>${machine.machine_name} (registered: ${new Date(machine.registered_at).toLocaleDateString()})</p>
            <button onclick="renameMachine('${machine.machine_id}')">rename</button>
            <button onclick="unregisterMachine('${machine.machine_id}')">unregister</button>
        `;
        machinesContainer.appendChild(machineElement);
    });
}

function renameMachine(machineId) {
    const newName = prompt('Enter new name for the machine:');
    if (!newName) return; // Exit if no name is entered

    const token = localStorage.getItem('userToken');
    fetch('https://paddle-cockroach-bouncrrr.onrender.com/api/update-machine-name', {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ machine_id: machineId, new_machine_name: newName })
    }).then(response => {
        if (response.ok) {
            alert('machine name updated successfully.');
            loadRegisteredMachines(); // Refresh the list
        } else {
            alert('failed to update machine name. please try again.');
        }
    });
}

function unregisterMachine(machineId) {
    if (!confirm('Are you sure you want to unregister this machine?')) return;

    const token = localStorage.getItem('userToken');
    fetch('https://paddle-cockroach-bouncrrr.onrender.com/api/unregister-machine', {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ machine_id: machineId })
    }).then(async response => {
        const data = await response.json(); // Assuming the server always sends a JSON response
        if (response.ok) {
            alert('machine unregistered successfully.');
            loadRegisteredMachines(); // Refresh the list
        } else {
            alert(data.message); // Display the server's error message
        }
    }).catch(error => {
        console.error('failed to unregister machine:', error);
        alert('failed to unregister machine. Please try again.');
    });
}

document.addEventListener('DOMContentLoaded', async function () {
    try {
        await loadMarketingOptInStatus();
        await loadSubscriptionStatus();
        await loadRegisteredMachines(); // Load machines when page loads
    } catch (error) {
        console.error('Error during initial data load:', error);
    }
});

        document.getElementById('change-password').addEventListener('click', function() {
    window.location.href = 'changepassword.html?token=' + localStorage.getItem('userToken');
});
</script>
</body>
</html>
