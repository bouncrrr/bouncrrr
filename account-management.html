<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>account management - bouncrrr</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="bouncrrr-favicon.ico" type="image/x-icon">
</head>
<body class="info-page">
    <div id="background-animation"></div>
    <div class="navbar navbar-visible" id="navbar">
        <a href="index.html">home</a>
    </div>
    <header>
        <h2>account management</h2>
    </header>
    <main>
        <section id="subscription-details" class="account-section">
            <h4>subscription details</h4>
            <p>Status: <span id="subscription-status">loading...</span></p>
            <button id="manage-subscription" class="account-button">manage subscription</button>
            <p id="subscription-message"></p>
        </section>
        <section id="email-preferences" class="account-section">
            <h4>email preferences</h4>
            <label for="marketing-emails" class="account-label">opt in for marketing emails:</label>
            <input type="checkbox" id="marketing-emails">
            <button id="update-email-preferences" class="account-button">update preferences</button>
            <p id="email-preference-message"></p>
        </section>
        <center><button id="logout-button" class="account-button">log out</button></center>
    </main>
    <footer>
        <a href="privacy.html">privacy notice</a> | 
        <a href="support.html">support</a> | 
        <a href="terms.html">terms of use/refund policy</a>
    </footer>

<script>
document.addEventListener('DOMContentLoaded', async function () {
    try {
        await loadMarketingOptInStatus();
        await loadSubscriptionStatus();
    } catch (error) {
        console.error('Error during initial data load:', error);
    }

    document.getElementById('update-email-preferences').addEventListener('click', updateMarketingOptInStatus);
    document.getElementById('logout-button').addEventListener('click', handleLogout);
    document.getElementById('manage-subscription').addEventListener('click', manageSubscription);
});

async function loadMarketingOptInStatus() {
    const paddleCustomerId = localStorage.getItem('paddleCustomerId');
    if (!paddleCustomerId) {
        console.error('Customer ID is missing.');
        return;
    }

    const url = `https://paddle-cockroach-bouncrrr.onrender.com/get-marketing-preferences?customerId=${paddleCustomerId}`;
    const response = await fetch(url);
    if (!response.ok) {
        throw new Error('Failed to fetch marketing opt-in status');
    }
    const data = await response.json();
    document.getElementById('marketing-emails').checked = data.marketingOptIn;
}

async function updateMarketingOptInStatus(e) {
    e.preventDefault();
    const paddleCustomerId = localStorage.getItem('paddleCustomerId');
    if (!paddleCustomerId) {
        console.error('Customer ID is missing.');
        return;
    }

    const marketingOptIn = document.getElementById('marketing-emails').checked;
    const url = `https://paddle-cockroach-bouncrrr.onrender.com/update-marketing-preferences`;
    const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ paddleCustomerId, marketingOptIn })
    });

    if (!response.ok) {
        throw new Error('Network response was not ok');
    }

    const responseMessage = await response.text();
    document.getElementById('email-preference-message').textContent = responseMessage;
}

async function loadSubscriptionStatus() {
    const url = 'https://paddle-cockroach-bouncrrr.onrender.com/api/get-subscription-status';
    const token = localStorage.getItem('userToken');
    if (!token) {
        console.error('User token is missing.');
        return;
    }

    const response = await fetch(url, {
        method: 'GET',
        headers: { 'Authorization': `Bearer ${token}` }
    });

    if (!response.ok) {
        throw new Error('Failed to fetch subscription status');
    }

    const { status } = await response.json();
    document.getElementById('subscription-status').textContent = status;
    updateManageSubscriptionButton(status);
}

function handleLogout() {
    console.log('Initiating logout process...');

    // Remove user-related information from local storage
    localStorage.removeItem('userEmail');
    localStorage.removeItem('userToken');
    localStorage.removeItem('paddleCustomerId');

    console.log('User credentials removed from local storage.');
    window.location.href = 'index.html';
}

function updateManageSubscriptionButton(status) {
    const manageButton = document.getElementById('manage-subscription');
    if (status === 'active') {
        manageButton.textContent = 'cancel subscription';
    } else {
        manageButton.textContent = 'subscribe';
    }
}

function manageSubscription() {
    const status = document.getElementById('subscription-status').textContent;
    if (status === 'active') {
        if (confirm('are you sure you want to cancel your subscription? this cannot be undone, and you will have to create a new subscription to continue using bouncrrr.')) {
            // Call to server to cancel subscription
            cancelSubscription();
        }
    } else {
        window.location.href = 'https://bouncrrr.co/index.html#pricing';
    }
}

async function cancelSubscription() {
    const customerId = localStorage.getItem('paddleCustomerId'); // Assuming this is stored when the user logs in
    const response = await fetch('https://paddle-cockroach-bouncrrr.onrender.com/api/cancel-subscription', {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${localStorage.getItem('userToken')}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ customerId }) // Sending customerId to the server
    });

    if (response.ok) {
        alert('Your subscription has been successfully canceled.');
        document.getElementById('subscription-status').textContent = 'inactive';
        updateManageSubscriptionButton('inactive');
    } else {
        const error = await response.json();
        console.error('Failed to cancel subscription:', error);
        alert('Failed to cancel subscription. Please try again or contact support.');
    }
}
</script>
</body>
</html>
