<script>
// Function to load the current marketing opt-in status
async function loadMarketingOptInStatus() {
    const paddleCustomerId = localStorage.getItem('paddleCustomerId'); // Retrieve the customer ID
    console.log('Loaded Customer ID:', paddleCustomerId); // Log the customer ID for verification

    if (!paddleCustomerId) {
        console.error('Customer ID is missing.');
        return; // Optionally handle this case more gracefully
    }

    const url = `https://paddle-cockroach-bouncrrr.onrender.com/get-marketing-preferences?customerId=${paddleCustomerId}`;
    const response = await fetch(url);
    if (!response.ok) {
        throw new Error('Failed to fetch marketing opt-in status');
    }
    const data = await response.json();
    document.getElementById('marketing-emails').checked = data.marketingOptIn;
}

// Function to update the marketing opt-in status
async function updateMarketingOptInStatus(e) {
    e.preventDefault(); // Prevent the form from submitting

    const paddleCustomerId = localStorage.getItem('paddleCustomerId'); // Retrieve the customer ID again
    console.log('Updating for Customer ID:', paddleCustomerId); // Log the customer ID for verification

    if (!paddleCustomerId) {
        console.error('Customer ID is missing.');
        return; // Optionally handle this case more gracefully
    }

    const marketingOptIn = document.getElementById('marketing-emails').checked;
    const url = `https://paddle-cockroach-bouncrrr.onrender.com/update-marketing-preferences`;

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ paddleCustomerId, marketingOptIn }),
        });

        if (!response.ok) {
            throw new Error('Network response was not ok');
        }

        const responseMessage = await response.text();
        document.getElementById('email-preference-message').textContent = responseMessage;
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('email-preference-message').textContent = 'Failed to update preferences. Please try again later.';
    }
}

// Attach event listeners after the DOM content has fully loaded to ensure elements are available
document.addEventListener('DOMContentLoaded', function () {
    document.getElementById('update-email-preferences').addEventListener('click', updateMarketingOptInStatus);
    loadMarketingOptInStatus(); // It's safer to call this here to ensure the DOM is fully loaded
});
</script>
